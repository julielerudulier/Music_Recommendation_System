-- Create tables:
CREATE TABLE customers (
    customer_id INT PRIMARY KEY,
    first_shop DATE,
    age INT,
    rewards VARCHAR(50),
    can_email VARCHAR(50));

INSERT INTO customers
VALUES (1, "2022-03-20", 23, "yes", "no"),(2, "2022-03-25", 26, "no", "no"),
(3, "2022-04-06", 32, "no", "no"),(4, "2022-04-13", 25, "yes", "yes"),
(5, "2022-04-22", 49, "yes", "yes"),(6, "2022-06-18", 28, "yes", "no"),
(7, "2022-06-30", 36, "no", "no"),(8, "2022-07-04", 37, "yes", "yes");


CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    customer_id INT,date_shop DATE,
    sales_channel VARCHAR(50),country_id INT,
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
    FOREIGN KEY (country_id) REFERENCES country(country_id));

INSERT INTO orders
VALUES (1, 1, "2023-01-16", "retail", 1), (2, 4, "2023-01-20", "retail", 1), (3, 2, "2023-01-25", "retail", 2),
(4, 3, "2023-01-25", "online", 1), (5, 1, "2023-01-28", "retail", 3), (6, 5, "2023-02-02", "online", 1),
(7, 6, "2023-02-05", "retail", 1), (8, 3, "2023-02-11", "online", 3);


CREATE TABLE country (
    country_id INT PRIMARY KEY,
    country_name VARCHAR(50),
    head_office VARCHAR(50));

INSERT INTO country
VALUES (1, "UK", "London"),(2, "USA", "New York"),(3, "China", "Beijing");


CREATE TABLE products (
    product_id INT PRIMARY KEY,
    category VARCHAR(50),
    price NUMERIC(5,2));

INSERT INTO products
VALUES (1, "food", 5.99),(2, "sports", 12.49),(3, "vitamins", 6.99), (4, "food", 0.89),(5, "vitamins", 15.99);


-- Number of countries having their head office in New York City:
SELECT COUNT(DISTINCT country_name)
FROM country
WHERE head_office = "New York";

-- Average age of customers who can receive marketing emails:
SELECT AVG(age)
FROM customers
WHERE can_email = "yes";

-- Number of orders made by each customer in each sales channel:
SELECT customer_id, sales_channel, COUNT(order_id) as numb_orders
FROM orders
GROUP BY customer_id;

-- Total revenue generated by each product category:
SELECT category, revenue, RANK()
OVER(
    ORDER BY revenue DESC) AS highest_revenue_ranks
    FROM(
        SELECT category, SUM(price) AS revenue
        FROM products
        GROUP BY category);

-- Average price of products in the "food" category:
SELECT category, AVG(price)
FROM products
WHERE category = "food";

-- Date of the latest order made by a customer who can receive marketing emails:
SELECT date_shop
FROM orders
WHERE (
    SELECT customer_id
    FROM customers
    WHERE can_email = "yes")
ORDER BY date_shop DESC
LIMIT 1;

-- Name and number of orders in the country with the highest number of orders:
SELECT country.country_name, COUNT(orders.order_id) as numb_orders
FROM country, orders
WHERE country.country_id = orders.country_id
GROUP BY orders.country_id
ORDER BY numb_orders DESC
LIMIT 1;
